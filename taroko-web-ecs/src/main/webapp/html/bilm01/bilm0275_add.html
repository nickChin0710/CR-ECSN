<html>

<head>
    <title>公共事業費用代繳授權書新增作業-add-109-06-16-V2.00.01-Amber-[Update]
    -109-0716-V2.00.02-Amber-[Update]
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="css/ecsBank.css" type="text/css">
    <script language="JavaScript" src="js/jquery.js"></script>
</head>

<body background="${water_mark}">
    <form name="dataForm" method="post" action="">
        <table border="0" cellpadding="0" cellspacing="0" style="margin-bottom:10px;">
            <tr>
                <td width="100">&nbsp;</td>
                <td>
                    <img height="30" src="images/upperLevel.gif" style="cursor:hand;" onClick="top.upperLevel()" ; alt="回上層" ;>&nbsp;
<!--                     <input type="Button" name="btnAdd" value=" 新增 " ${btnAdd_disable} onClick="return top.submitControl('A')" class="btAdd">&nbsp;&nbsp; -->
                    <input type="Button" name="btnAdd" value=" 新增 " ${btnAdd_disable} onClick="checkRun();" class="btAdd">&nbsp;&nbsp;
                    <input type="Button" name="btnClear" value=" 清除 " onClick="return top.submitControl('L')" class="btClear">&nbsp;&nbsp;
                </td>
            </tr>
        </table>
        <div id="dataBlock">
            <table width="40%" border="0" cellspacing="0" cellpadding="4">
                <!-- 輸入資料讀取條件  -->
                <tr>
                    <td nowrap>&nbsp;機構代號 :
                        <select id="kk_office_m_code" name="kk_office_m_code" class="col_ddlb" onChange="detailOfficeMCode(this.value)" zRequire="Y">
                            ${dddw_office_m_code}
                        </select>
                    </td>
                </tr>
            </table>
            <hr>
            <!-- Detail data================================= -->
            <table id="table1" width="40%" border="0" cellspacing="0" cellpadding="4">
                <tr id="tr">
                    <td id="td">&nbsp;分支機構 :
                        <select id="office_code" name="office_code" value="${office_code}" class="col_ddlb">
                            ${dddw_office_code}
                        </select>
                    </td>
                    <!-- <td style="color: red">${w_mesg}</td> -->
                </tr>
                <tr>
                    <td nowrap>&nbsp;用戶號碼 :
                        <input type="text" class="col_text" id="telephone_no" name="telephone_no" value="${telephone_no}" zEdit="any,upper" maxlength=12 size=12 zRequire="Y" />
                        <span class="dsp_text" style="color: red">${w_mesg}</span>
                    </td>
                </tr>
                <tr>
                    <td nowrap>&nbsp;卡&nbsp;&nbsp;&nbsp;&nbsp;號 :
                        <input type="text" class="col_any" name="card_no" value="${card_no}" zEdit="number" maxlength=19 size=21 onChange="detailCardNo(this.value)" />
                        <span style="background-color:#FFFF33" class="dsp_text2" id="card_desp" />
                    </td>
                </tr>
                <tr>
                    <td nowrap>&nbsp;身分證號 :
                        <input type="text" class="col_text" name="id_no" value="${id_no}" id="id_no" zEdit="alphanum,upper" maxlength=10 size=12 onChange="detailIdName(this.value)" />
                        <input type=text class="col_number" name="id_code" value="${id_code}" zeditType="number" maxlength="1" size="1" />
                        &nbsp;姓名 : <span style="background-color:#FFFF33" class="dsp_text2" id="id_name" />
                    </td>
                </tr>
                <tr>
                    <td nowrap>&nbsp;電腦編號 :
                        <input type="text" class="col_any" name="computer_no" value="${computer_no}" zEdit="any" maxlength=15 size=15 />
                    </td>
                </tr>
                <tr>
                    <td nowrap>&nbsp;作業代號 :
                        <select name="db_action" class="col_ddlb">
                            <option value="1" ${db_action-1}>新增</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td nowrap>&nbsp;備註 :
                        <input type="text" class="col_any" name="remark" value="${remark}" zEdit="any,canTW" maxlength="40" size="40" />        
                    </td>
                </tr>
            </table>
        </div><!-- -->
        <input type="hidden" name="ROWID" value="${rowid}">
        <input type="hidden" name="MOD_PGM" value="bilm0275">
        <input type="hidden" name="MOD_USER" value="${MOD_USER}">
        <input type="hidden" name="USERID" value="${userId}">
        <input type="hidden" name="MOD_SEQNO" value="${mod_seqno}">
        <input type="hidden" name="HIDE" value="${HIDE_DATA}">
        <input type="hidden" name="pageType" value="detl">
        <input type="hidden" name="id_p_seqno" id="id_p_seqno" value="${id_p_seqno}">        
        <input type="hidden" name="transaction_type" value="1">
        <input type="hidden" name="db_tmp" value="Y">
        <input type="hidden" name="error_code" value="">
        <input type="hidden" name="error_code1" value="">
        <input type="hidden" name="bank_no" id="bank_no" value="${bank_no}">
        <input type="hidden" name="confirm_date" value="">
        <input type="hidden" name="confirm_flag" value="">
        <input type="hidden" name="feed_back_date" value="">
        <input type="hidden" name="feed_back_tx_flag" value="">
        <input type="hidden" name="master_rowid" value="">
        <input type="hidden" name="tel_chkmark" value="">
        <input type="hidden" name="effc_date" value="">
        <input type="hidden" name="city_x160" value="">
        <input type="hidden" name="uniform_no" value="">
    </form>
</body>

</html>
<script language="JavaScript" src="js/AJAXFunction_11.js"></script>
<script language="javascript">
top.refreshButton2('1');
var idCode = "0";


function validateInput() {
    if (!top.checkFormat()) { return false; }

    return true;
}




function detailOfficeMCode(office_m_code) {
    idCode = "1";
    top.actionCode = "AJAX";
    resetJSON();
    addJSON("ajaxName", "office_m_code");
    addJSON("a_office_m_code", office_m_code);
    //addJSON("tot_term",$("select[name=tot_term]").val());
    processAJAX();

    return true;

}

function detailIdName(id) {

    idCode = "2";
    top.actionCode = "AJAX";
    resetJSON();
    addJSON("ajaxName", "idName");
    addJSON("id", id);
    processAJAX();
    return true;

}

function detailCardNo(card) {
    idCode = "3";
    top.actionCode = "AJAX";
    resetJSON();
    addJSON("ajaxName", "cardDesp");
    addJSON("card_no", card);
    processAJAX();
    return true;

}

function ajaxResponse() {
    top.respHtml = "bilm0275_add";
    top.requHtml = "bilm0275_add";
    if (idCode == "1") {
        if (getJSONvalue("dddw_office_code", 0) != null) {
            $("#table1 #tr #td select option").remove();
            $("#table1 #tr #td select").append(getJSONvalue("dddw_office_code", 0));
        }
    }

}

function checkRun() {
	console.log("checkRun");
	var ck_office_m_code =  $("#kk_office_m_code").val();
	var ck_telephone_no =  $("#telephone_no").val(); 
	var ck_office_code = $("#office_code").val();
	
	if(ck_office_m_code == "CHTG"){
		var regex = /\d{9}/; //	 	var regex = /^[0-9]{9} .?[0-9]*/;
		if (!regex.test(ck_telephone_no)){
			alert("機構代碼為CHTG,用戶號碼必須為9碼數字");
		}else{
			var li_1 = parseInt(ck_telephone_no.substring(0,1));
			var li_2 = parseInt(ck_telephone_no.substring(1,2));
			var li_3 = parseInt(ck_telephone_no.substring(2,3));
			var li_4 = parseInt(ck_telephone_no.substring(3,4));
			var li_5 = parseInt(ck_telephone_no.substring(4,5));
			var li_6 = parseInt(ck_telephone_no.substring(5,6));
			var li_7 = parseInt(ck_telephone_no.substring(6,7));
			var li_8 = parseInt(ck_telephone_no.substring(7,8));
			var li_9 = parseInt(ck_telephone_no.substring(8,9));
			var li_0 = (li_1 * 8 + li_2 * 7 + li_3 * 6 + li_4 * 5 + li_5 * 4 + li_6 * 3 + li_7 * 2 + li_8 * 1);
			var li_0 = (11 - li_0 % 11) % 10;
			
// 			console.log(li_1+","+li_2+","+li_3+","+li_4+","+li_5+","+li_6+","+li_7+","+li_8+","+li_9);
// 			console.log(li_0);	
			
			if (li_0 != li_9) {
				alert("此資料檢查碼錯誤!!");
			}else{
				top.submitControl('A');
			}
		}
		
	}else if(ck_office_m_code == "TE"){
		wf_chk_tel("TE", ck_office_code, ck_telephone_no);
	}else if(ck_office_m_code == "TW"){
		wf_chk_tel("TW", ck_office_code, ck_telephone_no);
	}else if(ck_office_m_code == "CC"){
		wf_chk_tel("CC", ck_office_code, ck_telephone_no);
	}else{
		top.submitControl('A');
	}

}

function wf_chk_tel(as_mcode,as_code,as_tel){
	var ll_tel = new Array();//var ll_tel = [];
	var ls_tmp = "",ls_tmp2 = "";

	if (as_mcode == "TE") {
		as_code = (as_code + as_tel).substring(0, 10);
		var ll_sum = 0;
		for (var i = 0; i < 10; i++) {
			ll_tel[i] = parseInt(as_code.substring(i, i + 1));
			if(i % 2 == 0){
				ll_sum += ll_tel[i];
			}else{
				if ((ll_tel[i] * 2) >= 10) {
					ll_sum += parseInt((ll_tel[i] * 2).toString().substring(0, 1));
					ll_sum += ((ll_tel[i] * 2) - 10);
				}else{
					ll_sum += (ll_tel[i]) * 2;
				}
			}
		}
		ls_tmp = ll_sum.toString().substring(ll_sum.toString().length - 1);
// 		console.log("ls_tmp="+ls_tmp);
// 		console.log("if="+as_tel.substring(as_tel.toString().length - 1));

		if(as_tel.substring(as_tel.length - 1 )!= ls_tmp){
			var resp = confirm("公用事業~費用代繳之用戶號碼檢核不符,是否強制輸入?");
	        if (resp == true) {
	        	top.submitControl('A');
	        } else {
	            return;
	        }
		}else{
			top.submitControl('A');
		}

	}else if(as_mcode == "TW"){
		as_code = (as_tel).substring(0, 6);
		var ll_sum = 0;
		for (var i = 0; i < 6; i++) {
			ll_tel[i] = parseInt(as_code.substring(i, i + 1));
			if (i % 2 == 0) {
				ll_sum += ll_tel[i];
			}else {
				ll_sum += (ll_tel[i] * 2);
			}
		}
		ls_tmp = (10 - (ll_sum % 10)).toString();
// 		console.log("ls_tmp="+ls_tmp);
// 		console.log("if="+as_tel.substring(as_tel.toString().length - 1));

		if (as_tel.substring(as_tel.length - 1) != ls_tmp) {
			var resp = confirm("公用事業~費用代繳之用戶號碼檢核不符,是否強制輸入?");
	        if (resp == true) {
	        	top.submitControl('A');
	        } else {
	            return;
	        }
		}else{
			top.submitControl('A');
		}
	}else{//CC
		var ls_cc = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
		var ls_cc2 ="12345678912345678912345678";
		
		for (var i = 0; i < 2; i++) {
			var ll_sum = 0;

			if (as_code.substring(i, i + 1) <= 9) {
				continue;
			}else{
				ls_tmp = as_code.substring(i, i + 1);
			}
			
			
			// 轉abc=123
			if (!ls_tmp == "0") {
				for (var j = 0; j < 26; j++) {
					ls_tmp2 = ls_cc.substring(j, j + 1);
					if (ls_tmp == ls_tmp2) {
						ls_tmp = ls_cc2.substring(j, j + 1);
					}
				}
			}
			
			if (i == 0) {
				as_code = ls_tmp + as_code.substring(i + 1);
			}
			
			if (i == 1) {
				as_code = as_code.substring(0, 1) + ls_tmp + as_code.substring(i + 1);
			}
			
		}
		
		// goto TAG_cc
		as_code = (as_code + as_tel).substring(0, 10);
		var ll_sum = 0;
		var j = 0,k = 0;
		
		for(var i = 0; i < 10; i++){
			ll_tel[i] = parseInt(as_code.substring(i, i + 1));
			if(i+1 < 5){ // 權數k
				k = i;
			}else {
				j += 1;
				k = 11 - j;
			}
			ll_sum += (ll_tel[i] * k);
		}
		
		
		j = parseInt(ll_sum % 11); // 餘數
		console.log("j="+j);
		if (j == 0) {
			ls_tmp = "0";
		}else if (j == 1) {
			ls_tmp = "K";
		}else {
			ls_tmp = (11 - (ll_sum % 11)).toString(); // 省水查核碼.求11的補數
			
		}
// 		console.log("ls_tmp="+ls_tmp);
// 		console.log("if="+as_tel.substring(as_tel.toString().length - 1));

		if(as_tel.substring(as_tel.toString().length - 1 ) != ls_tmp){
			var resp = confirm("公用事業~費用代繳之用戶號碼檢核不符,是否強制輸入?");
	        if (resp == true) {
	        	top.submitControl('A');
	        } else {
	            return;
	        }
		}else{
			top.submitControl('A');
		}
	}
	
}

// function to_int(s1){
// 	s1 =s1.trim(); //.replaceAll(/,/g,"")
// 	if(isNaN(s1)){
// 		return 1;
// 	}else{
// 		return parseInt(s1);
// 	}

// }

// if (1 == 2 $ { conf_cond }) {
//     var resp = confirm('${conf_mesg}');
//     if (resp == false) {

//     } else {
//         document.dataForm.conf_flag.value = "Y";
//         top.submitControl('A');
//     }
// }
</script>